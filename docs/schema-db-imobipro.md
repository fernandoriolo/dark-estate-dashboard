# Schema do Banco ImobiPRO ‚Äî Guia Did√°tico

Este documento explica de forma did√°tica como funciona o banco de dados do sistema ImobiPRO, suas tabelas, relacionamentos e regras de neg√≥cio. √â destinado tanto para desenvolvedores quanto para usu√°rios que precisam entender a estrutura de dados.

## üìã Vis√£o Geral

O ImobiPRO √© um sistema de gest√£o imobili√°ria com **arquitetura multi-tenant** (v√°rias empresas no mesmo banco) e **controle rigoroso de acesso** por hierarquia de usu√°rios.

### Conceitos Fundamentais
- **Multi-tenant**: Cada empresa tem seus dados isolados via `company_id`
- **Row Level Security (RLS)**: Cada linha da tabela tem regras espec√≠ficas de acesso
- **Hierarquia de usu√°rios**: Admin > Gestor > Corretor (cada um v√™ e faz coisas diferentes)

---

## üè¢ Estrutura Principal

### 1. **companies** ‚Äî Empresas/Imobili√°rias
**O que √©**: Cadastro das empresas imobili√°rias que usam o sistema.

**Campos principais**:
- `id` (uuid): Identificador √∫nico da empresa
- `name`: Nome da imobili√°ria
- `cnpj`: CNPJ da empresa
- `plan`: Plano contratado ('basico', 'profissional', 'enterprise')
- `max_users`: Limite de usu√°rios por plano
- `is_active`: Se a empresa est√° ativa
- `owner_user_id`: ID do usu√°rio propriet√°rio/respons√°vel

**Quem pode acessar**:
- **Usu√°rios da pr√≥pria empresa**: podem ver dados da sua empresa
- **Admins**: podem ver/gerenciar qualquer empresa

---

### 2. **user_profiles** ‚Äî Perfis dos Usu√°rios
**O que √©**: Informa√ß√µes dos usu√°rios do sistema (corretores, gestores, admins).

**Campos principais**:
- `id` (uuid): Mesmo ID do usu√°rio autenticado no Supabase
- `email`: Email de login
- `full_name`: Nome completo
- `role`: Papel no sistema ('corretor', 'gestor', 'admin')
- `company_id`: A qual empresa pertence
- `phone`: Telefone de contato
- `is_active`: Se o usu√°rio est√° ativo

**Relacionamentos**:
- Pertence a uma `companies` (via `company_id`)
- √â referenciado por quase todas as outras tabelas (via `user_id`)

**Quem pode acessar**:
- **Cada usu√°rio**: pode ver/editar apenas seu pr√≥prio perfil
- **Gestores**: podem ver perfis dos usu√°rios da mesma empresa

---

### 3. **imoveisvivareal** ‚Äî Sistema Principal de Im√≥veis (TABELA ATIVA)
**O que √©**: Tabela √öNICA e FUNCIONAL para todos os im√≥veis do sistema, sejam importados de portais (VivaReal, ZAP) ou cadastrados manualmente.

**Campos principais**:
- `id` (serial): Identificador √∫nico sequencial
- `listing_id`: ID original do portal (se importado)
- `tipo_categoria`: Categoria do im√≥vel
- `tipo_imovel`: Tipo espec√≠fico (apartamento, casa, etc.)
- `descricao`: Descri√ß√£o detalhada
- `preco`: Pre√ßo do im√≥vel
- `tamanho_m2`: √Årea em m¬≤
- `quartos`, `banheiros`: Quartos e banheiros
- `cidade`, `bairro`, `endereco`: Localiza√ß√£o completa
- `imagens[]`: **Array com URLs das fotos** (armazena as imagens diretamente)
- `features[]`: Array de caracter√≠sticas (piscina, garagem, etc.)
- `user_id`: Corretor respons√°vel
- `company_id`: Empresa propriet√°ria

**Relacionamentos**:
- Pertence a um `user_profiles` (corretor respons√°vel)
- Pertence a uma `companies`
- **N√£o usa tabela separada para imagens** - armazena no campo `imagens[]`
- Pode ter v√°rios `leads` interessados

**Quem pode acessar**:
- **Admin/Gestor**: podem ver/editar todos os im√≥veis da empresa
- **Corretor**: pode ver todos, mas s√≥ editar disponibilidade dos seus

---

### 4. **properties** e **property_images** ‚Äî Tabelas Legado (N√ÉO UTILIZADAS)
**O que s√£o**: Tabelas originais para im√≥veis e fotos, **mantidas apenas para compatibilidade**.

**Status atual**: 
- **N√ÉO est√£o sendo usadas** no sistema funcional
- Todos os im√≥veis s√£o gerenciados via `imoveisvivareal`
- Mantidas no banco para evitar quebra de refer√™ncias
- **N√£o devem ser usadas** para novos desenvolvimentos

---

### 5. **leads** ‚Äî Clientes Interessados
**O que √©**: Pessoas interessadas em im√≥veis (clientes em potencial).

**Campos principais**:
- `id` (uuid): Identificador √∫nico do lead
- `name`: Nome do cliente
- `email`, `phone`: Contatos
- `property_id`: Im√≥vel de interesse (referencia `imoveisvivareal`)
- `source`: De onde veio ('site', 'whatsapp', 'indica√ß√£o')
- `stage`: Est√°gio no funil ('Novo Lead', 'Visita Agendada', etc.)
- `message`: Mensagem inicial
- `user_id`: Corretor respons√°vel
- `company_id`: Empresa

**Relacionamentos**:
- Pertence a um `imoveisvivareal` (im√≥vel de interesse)
- Pertence a um `user_profiles` (corretor respons√°vel)
- Pode gerar `contracts` (se fechar neg√≥cio)
- Gera `imobipro_messages` (conversas)

**Quem pode acessar**:
- **Admin/Gestor**: podem ver/gerenciar todos os leads da empresa
- **Corretor**: pode ver/gerenciar apenas os leads atribu√≠dos a ele

---

### 6. **contracts** ‚Äî Contratos de Loca√ß√£o/Venda
**O que √©**: Contratos formalizados entre cliente e propriet√°rio.

**Campos principais**:
- `id` (text): N√∫mero √∫nico do contrato
- `numero`: N√∫mero sequencial
- `tipo`: Tipo de contrato ('Locacao' ou 'Venda')
- `status`: Status atual ('ativo', 'finalizado', etc.)
- `property_id`: Im√≥vel contratado (referencia `imoveisvivareal`)
- `template_id`: Template usado
- `client_*`: Dados do cliente (nome, cpf, etc.)
- `landlord_*`: Dados do propriet√°rio
- `valor_*`: Valores financeiros
- `user_id`: Corretor respons√°vel
- `company_id`: Empresa

**Relacionamentos**:
- Baseado em um `imoveisvivareal`
- Usa um `contract_templates`
- Criado por um `user_profiles`

**Quem pode acessar**:
- **Admin/Gestor**: podem ver/gerenciar todos os contratos da empresa
- **Corretor**: pode ver/gerenciar apenas os contratos que criou

---

### 7. **contract_templates** ‚Äî Modelos de Contrato
**O que √©**: Templates/modelos prontos para gerar contratos.

**Campos principais**:
- `id` (text): Identificador do template
- `name`: Nome do modelo
- `template_type`: Tipo ('Locacao' ou 'Venda')
- `file_name`, `file_path`: Arquivo do template
- `user_id`: Quem criou
- `is_active`: Se est√° ativo

**Relacionamentos**:
- Criado por um `user_profiles`
- Usado para gerar `contracts`

**Quem pode acessar**:
- **Leitura/cria√ß√£o**: qualquer usu√°rio autenticado
- **Edi√ß√£o/exclus√£o**: apenas admin/gestor ou quem criou

---

## üí¨ Sistema de Comunica√ß√£o

### 8. **imobipro_messages** ‚Äî Sistema Principal de Mensagens
**O que √©**: Sistema central de mensagens do WhatsApp integrado ao CRM.

**Campos principais**:
- `id` (uuid): ID √∫nico da mensagem
- `instancia`: Inst√¢ncia WhatsApp origem
- `chat_id`: ID do chat/conversa
- `lead_id`: Lead relacionado (se aplic√°vel)
- `message_type`: Tipo da mensagem (text, image, etc.)
- `content`: Conte√∫do da mensagem
- `from_me`: Se foi enviada pelo corretor (true/false)
- `timestamp`: Quando foi enviada

**Relacionamentos**:
- Conecta com `leads` (via `lead_id`)
- Conecta com `whatsapp_instances` (via `instancia`)

**Quem pode acessar**:
- **Admin**: acesso total
- **Gestor**: pode ver/gerenciar mensagens da empresa
- **Corretor**: acesso baseado em inst√¢ncia:
  - Inst√¢ncia 'sdr': todos podem acessar
  - Outras inst√¢ncias: apenas se vinculada √† sua empresa

### 9. **whatsapp_instances** ‚Äî Configura√ß√£o das Inst√¢ncias WhatsApp
**O que √©**: Configura√ß√µes de cada "n√∫mero" WhatsApp conectado ao sistema.

**Campos principais**:
- `id` (uuid): ID √∫nico da inst√¢ncia
- `instance_name`: Nome da inst√¢ncia (√∫nico)
- `phone_number`: N√∫mero do WhatsApp
- `profile_name`: Nome do perfil
- `status`: Status da conex√£o
- `user_id`: Usu√°rio respons√°vel
- `company_id`: Empresa propriet√°ria

**Relacionamentos**:
- Pertence a um `user_profiles`
- Pertence a uma `companies`
- Controla acesso √†s `imobipro_messages`

**Quem pode acessar**:
- **Admin**: pode gerenciar qualquer inst√¢ncia
- **Gestor**: pode gerenciar inst√¢ncias da sua empresa
- **Corretor**: pode gerenciar apenas suas pr√≥prias inst√¢ncias

### 10. **whatsapp_chats** e **whatsapp_messages** ‚Äî Sistema Legado
**O que √©**: Sistema anterior de mensagens, mantido para compatibilidade.

**Status atual**: 
- Tabelas mantidas no banco mas n√£o s√£o mais usadas ativamente
- Sistema migrou para `imobipro_messages`
- Ainda referenciadas nas pol√≠ticas RLS para controle

---

## üîê Sistema de Permiss√µes

### 11. **role_permissions** ‚Äî Controle Granular de Acesso
**O que √©**: Define quais funcionalidades cada tipo de usu√°rio pode acessar.

**Campos principais**:
- `id` (uuid): ID √∫nico da permiss√£o
- `role`: Tipo de usu√°rio ('corretor', 'gestor', 'admin')
- `permission_key`: Chave da permiss√£o (ex: 'menu_leads')
- `permission_name`: Nome amig√°vel
- `category`: Categoria (ex: 'Menu', 'A√ß√£o')
- `is_enabled`: Se est√° habilitada

**Como funciona**:
- Cada funcionalidade do sistema tem uma `permission_key`
- Para cada `role`, define-se se tem ou n√£o acesso (`is_enabled`)
- Sistema consulta esta tabela antes de mostrar menus/bot√µes

**Quem pode acessar**:
- **Admin**: pode alterar qualquer permiss√£o
- **Gestor**: pode ver permiss√µes de corretor (para configurar)
- **Corretor**: pode apenas ver suas pr√≥prias permiss√µes

---

## üîó Como as Tabelas se Relacionam

```mermaid
erDiagram
    companies ||--o{ user_profiles : "company_id"
    companies ||--o{ imoveisvivareal : "company_id"
    companies ||--o{ leads : "company_id"
    companies ||--o{ whatsapp_instances : "company_id"
    
    user_profiles ||--o{ imoveisvivareal : "user_id (respons√°vel)"
    user_profiles ||--o{ leads : "user_id (respons√°vel)"
    user_profiles ||--o{ contracts : "user_id (criador)"
    user_profiles ||--o{ whatsapp_instances : "user_id (dono)"
    
    imoveisvivareal ||--o{ leads : "property_id (interesse)"
    imoveisvivareal ||--o{ contracts : "property_id (contratado)"
    
    leads ||--o{ imobipro_messages : "lead_id (conversa)"
    leads ||--o{ contracts : "lead ‚Üí contrato"
    
    contract_templates ||--o{ contracts : "template_id"
    
    whatsapp_instances ||--o{ imobipro_messages : "instancia (controle)"
    
    properties : "LEGADO - N√ÉO USADO"
    property_images : "LEGADO - N√ÉO USADO"
```

## üõ°Ô∏è Regras de Seguran√ßa (RLS)

### Princ√≠pios Gerais
1. **Isolamento por empresa**: Cada empresa v√™ apenas seus dados
2. **Hierarquia de acesso**: Admin > Gestor > Corretor
3. **Propriedade individual**: Corretores veem principalmente o que √© "deles"

### Por Tipo de Usu√°rio

**üî¥ Admin**
- Acesso global a tudo
- Pode gerenciar qualquer empresa
- Invis√≠vel para outros usu√°rios
- Gerencia permiss√µes de gestor e corretor

**üü° Gestor** 
- V√™ todos os dados da pr√≥pria empresa
- Pode gerenciar corretores da empresa
- Configura permiss√µes dos corretores
- Pode reatribuir leads/im√≥veis entre corretores

**üü¢ Corretor**
- V√™ apenas dados atribu√≠dos a ele
- Pode ver todos os im√≥veis mas s√≥ editar disponibilidade
- Acessa conversas apenas dos seus leads
- Pode criar leads e contratos

---

## üìù Observa√ß√µes Importantes

### ‚ö†Ô∏è ATEN√á√ÉO: Tabela Funcional vs Legado
- **USAR**: `imoveisvivareal` para TODOS os im√≥veis (importados ou manuais)
- **N√ÉO USAR**: `properties` e `property_images` (apenas legado)
- **Imagens**: Armazenadas no array `imagens[]` da tabela `imoveisvivareal`

### Triggers Autom√°ticos
- Quando um registro √© inserido, `user_id` e `company_id` s√£o preenchidos automaticamente
- Sistema impede "falsificar" empresa (spoof de `company_id`)

### Fun√ß√µes de Seguran√ßa
- `get_current_role()`: Retorna o papel do usu√°rio atual
- `get_user_company_id()`: Retorna a empresa do usu√°rio atual
- `_admin_global()`: Verifica se √© admin global

### Manuten√ß√£o
- Este documento deve ser atualizado a cada migration no Supabase
- Mudan√ßas no RLS devem refletir aqui
- Novos campos/tabelas devem ser documentados

---

**√öltima atualiza√ß√£o**: 24/08/2025 - Corrigido: `imoveisvivareal` como tabela √∫nica funcional para im√≥veis
**Pr√≥xima revis√£o**: A cada migration ou mudan√ßa estrutural significativa